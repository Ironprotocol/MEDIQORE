<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEDIQORE - Data Page</title>
    <!-- Google Fonts 추가 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/sidebar1.css">
    <link rel="stylesheet" href="css/sidebar2.css">
    <link rel="stylesheet" href="css/topbar.css">
    <link rel="stylesheet" href="css/registration.css">
    <link rel="stylesheet" href="css/desk.css">
    <link rel="stylesheet" href="css/calendar.css">
    <link rel="stylesheet" href="css/tooltip_calendar.css">
    <link rel="stylesheet" href="css/common.css">
</head>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: 'Noto Sans KR', sans-serif;  /* 기본 글씨체 설정 */
            background-color: rgb(201, 214, 255);  /* 기본 배경색 설정 */
            user-select: none;  /* 텍스트 선택 비활성화 */
            -webkit-user-select: none;  /* Safari용 */
            -moz-user-select: none;  /* Firefox용 */
            -ms-user-select: none;  /* IE용 */
        }
    </style>
    <script type="module">
        import {app, auth, db, doc, getDoc, setDoc, collection, query, where, getDocs, updateDoc,  serverTimestamp, Timestamp,onSnapshot,orderBy } from './js/firebase-config.js';
        import {setupCloseButtons, setupLogoLogout, initializeStatusSelector, initializeZoomPrevention,displayUserName,initializeUserName} from './js/common.js';
        import {checkUserPermissions, initializeMenuEvents} from './js/desk-menu.js';
        import {initializePatientList} from './js/patient-list.js';
        import {initializeRoomManagement, handleRoomLogout} from './js/room.js';
        import {initializeSubmenuEvents, initializeSubmenuItemEvents } from './js/sidebar2.js';
        import {CustomCalendar,initializeScheduler} from './js/calendar.js';
        import {handleComplaintChange, initializeNewPatientButton, loadDoctors, initializeAddressSearch, initializeInsuranceForm, initializeRegistrationForm} from './js/patient-registration.js';
        import {initializePrescription} from './js/prescription.js';

        // 전역 함수
        window.app = app;
        window.auth = auth;
        window.db = db;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.serverTimestamp = serverTimestamp;
        window.Timestamp = Timestamp;  // Timestamp를 window 객체에 추가

            // 의사 상태 아이콘 설정 수정
            const statusIcons = {
                login: 'image/login.png',
                start: 'image/start.png',
                end: 'image/logout.png',
                break: 'image/break.png'
                };
                
            // UI 요소 생성
            const actionButtons = document.querySelector('.action-buttons');
            if (actionButtons) {
                  actionButtons.innerHTML = `
                      <button class="action-button">
                          <div class="action-button-placeholder" title="채팅"></div>
                      </button>
                      <button class="action-button">
                          <div class="action-button-placeholder" title="알림"></div>
                      </button>
                      <span class="user-name"></span>
                      <div class="status-selector">
                          <div class="current-status">
                              <img src="${statusIcons.login}" alt="Status" class="status-icon">
                          </div>
                          <div class="status-dropdown">
                              <div class="status-option" data-status="login">
                                  <img src="${statusIcons.login}" alt="Login" class="status-icon">
                                  <span>Login</span>
                              </div>
                              <div class="status-option" data-status="start">
                                  <img src="${statusIcons.start}" alt="Start Work" class="status-icon">
                                  <span>Start</span>
                              </div>
                              <div class="status-option" data-status="end">
                                  <img src="${statusIcons.end}" alt="End Work" class="status-icon">
                                  <span>End</span>
                              </div>
                              <div class="status-option" data-status="break">
                                  <img src="${statusIcons.break}" alt="Break" class="status-icon">
                                  <span>Break</span>
                              </div>
                          </div>
                      </div>
                  `;
                }

            initializeNewPatientButton(); // New patient 버튼 초기화
            initializeUserName();       //common.js - 우측 상단 의사 이름 초기화
            initializeStatusSelector(); //common.js - 우측 상단 의사 상태 초기화

            auth.onAuthStateChanged(async (user) => {
                    if (!user) {
                        window.location.href = 'main.html';
                        return;
                    } //회원 아니면 돌려보냄
         
            try {
              await checkUserPermissions(user);
              const hospitalName = user.email.split('@')[0].split('.')[0]; // hospitalName 추출
              const currentDate = document.querySelector('.current-date').textContent; // 현재 날짜 가져오기
              await initializePatientList(hospitalName, currentDate); //patient-list.js - 환자 리스트 전체 관리
              await initializeRoomManagement(hospitalName);  //room 관리 
              initializePrescription();  // Prescription 초기화
                
              auth.onAuthStateChanged(async (user) => {
                    if (!user) {
                       await handleRoomLogout();  // room - 로그아웃 감지 및 처리를 위한 추가 리스너
                    }
                    });
                    } 
                    catch (error) {
                        console.error('Error:', error);
                            alert('Error loading user permissions. Please try again.');
                            await auth.signOut();
                        window.location.href = 'main.html';
                    }
            initializeSubmenuEvents()
            initializeSubmenuItemEvents(); // sidebar2 - submenu 클릭 이벤트 처리  
            });        
            setupCloseButtons();           //닫기 버튼 기능    
            setupLogoLogout();             // 로고 클릭 이벤트 설정

            // 환자 등록 - patient registration
            initializeAddressSearch();
            initializeInsuranceForm();
            initializeRegistrationForm();
            initializeMenuEvents();     // 메뉴 클릭 시 - sidebar1 메뉴 항목 조정

            function updateDate() {
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const month = months[today.getMonth()];
                const year = today.getFullYear();
                const formattedDate = `${day}.${month}.${year}`;
                document.querySelector('.current-date').textContent = formattedDate;
                }
            
            updateDate();               // 페이지 로드 시 날짜 업데이트
            initializeZoomPrevention(); // 확대/축소 방지 기능 초기화
            initializeScheduler();


    </script>
</head>
<body>
    <div class="sidebar1">
        <div class="logo-container">
            <img src="image/logo.png" alt="MEDIQORE Logo" class="logo-image">
            <span class="logo-text">MEDIQORE</span>
        </div>
        <div class="menu-container">
            <div class="menu-item">
                <img src="image/home_black.png" alt="Home" class="menu-icon menu-icon-default">
                <img src="image/home.png" alt="Home" class="menu-icon menu-icon-active">
                Home
            </div>
            <div class="menu-item">
                <img src="image/desk_black.png" alt="Desk" class="menu-icon menu-icon-default">
                <img src="image/desk.png" alt="Desk" class="menu-icon menu-icon-active">
                Desk
            </div>
            <div class="menu-item">
                <img src="image/prescription_black.png" alt="Prescription" class="menu-icon menu-icon-default">
                <img src="image/prescription.png" alt="Prescription" class="menu-icon menu-icon-active">
                Prescription
            </div>
            <div class="menu-item">
                <img src="image/reservation_black.png" alt="Reservation" class="menu-icon menu-icon-default">
                <img src="image/reservation.png" alt="Reservation" class="menu-icon menu-icon-active">
                Reservation
            </div>
            <div class="menu-item">
                <img src="image/pharmacy_black.png" alt="Pharmacy" class="menu-icon menu-icon-default">
                <img src="image/pharmacy.png" alt="Pharmacy" class="menu-icon menu-icon-active">
                Pharmacy
            </div>
            <div class="menu-item">
                <img src="image/data_black.png" alt="Data" class="menu-icon menu-icon-default">
                <img src="image/data.png" alt="Data" class="menu-icon menu-icon-active">
                Data
            </div>
        </div>
        <div class="version-container">
            <div class="divider"></div>
            <div class="version-info">v.0.0187 test</div>
        </div>
    </div>
    <div class="top-bar">
        <div class="page-title">Chart</div>
        <div class="search-form">
            <input type="text" class="search-input" placeholder="Patient Search">
        </div>
        <button class="new-patient-btn">New Patient</button>
        <div class="action-buttons">
            <button class="action-button">
                <div class="action-button-placeholder" title="채팅"></div>
            </button>
            <button class="action-button">
                <div class="action-button-placeholder" title="알림"></div>
            </button>
            <span class="user-name"></span>
            <div class="status-selector">
                <div class="current-status">
                    <img src="image/login.png" alt="Status" class="status-icon">
                </div>
                <div class="status-dropdown">
                    <div class="status-option" data-status="login">
                        <img src="image/login.png" alt="Login" class="status-icon">
                        <span>Login</span>
                    </div>
                    <div class="status-option" data-status="start">
                        <img src="image/start.png" alt="Start Work" class="status-icon">
                        <span>Start</span>
                    </div>
                    <div class="status-option" data-status="end">
                        <img src="image/logout.png" alt="End Work" class="status-icon">
                        <span>End</span>
                    </div>
                    <div class="status-option" data-status="break">
                        <img src="image/break.png" alt="Break" class="status-icon">
                        <span>Break</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="sidebar2">
        <div class="patient-list-title">Treatment progress list</div>
        <div class="submenu-container">
            <div class="submenu-item active">Waiting</div>
            <div class="submenu-item">RSVD</div>
            <div class="submenu-item">Visit</div>
        </div>

        <div class="patient-list-container">
            <!-- Room/Desk UI가 여기에 동적으로 추가됨 -->
        </div>

        <!-- RSVD 컨테이너 -->
        <div class="rsvd-list-container">
            <!-- RSVD 목록이 여기에 추가될 것임 -->
        </div>

        <!-- Visit 컨테이너 -->
        <div class="visit-list-container">
            <!-- Visit 목록이 여기에 추가될 것임 -->
        </div>

        <div class="bottom-container">
            <!-- 하단 컨테이너 내용 -->
        </div>
    </div>
    <div class="main-content">
        <div id="data-content" class="content-container data-container">
            <div class="content-header">
                <div class="content-title">Data</div>
                <button class="close-button">Close</button>
            </div>
        </div>
        
        <div id="patient-registration-content" class="content-container">
            <div class="content-header">
                <div class="content-title">Patient Registration</div>
                <button class="close-button">Close</button>
            </div>
            <div class="vertical-line-left"></div>
            <div class="vertical-line-right"></div>
            <div class="patient-registration-form">
                <div class="form-container">
                    <div class="section-box">
                        <h3>Personal Information</h3>
                        <div class="form-group">
                            <label for="patientName">Patient Name</label>
                            <input type="text" id="patientName" name="patientName" required>
                        </div>
                        <div class="form-group">
                            <label for="idNumber">ID Card / Passport number</label>
                            <input type="text" id="idNumber" name="idNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">Cell phone number</label>
                            <input type="tel" id="phoneNumber" name="phoneNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="birthDay">Birth Date</label>
                            <div class="date-select-group">
                                <select id="birthDay" name="birthDay" required>
                                    <option value="">Day</option>
                                    <script>
                                        for(let i = 1; i <= 31; i++) {
                                            document.write(`<option value="${i}">${i}</option>`);
                                        }
                                    </script>
                                </select>
                                <select id="birthMonth" name="birthMonth" required>
                                    <option value="">Month</option>
                                    <option value="1">Jan</option>
                                    <option value="2">Feb</option>
                                    <option value="3">Mar</option>
                                    <option value="4">Apr</option>
                                    <option value="5">May</option>
                                    <option value="6">Jun</option>
                                    <option value="7">Jul</option>
                                    <option value="8">Aug</option>
                                    <option value="9">Sep</option>
                                    <option value="10">Oct</option>
                                    <option value="11">Nov</option>
                                    <option value="12">Dec</option>
                                </select>
                                <select id="birthYear" name="birthYear" required>
                                    <option value="">Year</option>
                                    <script>
                                        const currentYear = new Date().getFullYear();
                                        for(let i = currentYear; i >= currentYear - 100; i--) {
                                            document.write(`<option value="${i}">${i}</option>`);
                                        }
                                    </script>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="district">Address</label>
                            <div class="address-details">
                                <input type="text" id="district" name="district" placeholder="District">
                                <input type="text" id="city" name="city" placeholder="City">
                                <input type="text" id="state" name="state" placeholder="State">
                                <div id="addressResults" class="address-results"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="primaryComplaint">Primary Complaint</label>
                            <select id="primaryComplaint" name="primaryComplaint" required>
                                <option value="">Select primary complaint</option>
                                <option value="toothache">Toothache</option>
                                <option value="sensitivity">Tooth Sensitivity</option>
                                <option value="bleeding_gums">Bleeding Gums</option>
                                <option value="swollen_gums">Swollen Gums</option>
                                <option value="bad_breath">Bad Breath</option>
                                <option value="loose_tooth">Loose Tooth</option>
                                <option value="cavity">Cavity/Decay</option>
                                <option value="broken_tooth">Broken/Chipped Tooth</option>
                                <option value="wisdom_tooth">Wisdom Tooth Pain</option>
                                <option value="jaw_pain">Jaw Pain</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group" id="otherComplaintContainer" style="display: none;">
                            <label for="otherComplaint">Specify Other Complaint</label>
                            <textarea id="otherComplaint" name="otherComplaint" 
                                    style="height: 84px; resize: none;"></textarea>
                        </div>
                    </div>
                    <div class="section-box">
                        <h3>Insurance Information</h3>
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="radio" id="hasInsurance" name="insuranceStatus" value="has">
                                <label for="hasInsurance">Have Medical Insurance</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="radio" id="noInsurance" name="insuranceStatus" value="none">
                                <label for="noInsurance">No Insurance</label>
                            </div>
                        </div>
                        <div class="insurance-details" style="display: none;">
                            <div class="form-group">
                                <label for="insuranceProvider">Insurance Provider</label>
                                <select id="insuranceProvider" name="insuranceProvider">
                                    <option value="">Select insurance provider</option>
                                    <option value="discovery">Discovery Health</option>
                                    <option value="momentum">Momentum Health</option>
                                    <option value="bonitas">Bonitas Medical Fund</option>
                                    <option value="medihelp">Medihelp</option>
                                    <option value="fedhealth">Fedhealth</option>
                                    <option value="medshield">Medshield</option>
                                    <option value="bestmed">Bestmed</option>
                                    <option value="keyhealth">KeyHealth</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="insuranceNumber">Insurance Card Number</label>
                                <input type="text" id="insuranceNumber" name="insuranceNumber">
                            </div>
                        </div>
                    </div>
                    <div class="section-box">
                    </div>
                </div>
            </div>
            <div class="content-footer">
                <button class="register-btn">Register</button>
            </div>
        </div>



        <!--------------------------------------------------- Desk 메뉴용 컨테이너 -------------------------------------------------------------->
        <div id="desk-content" class="content-container desk-container">
            <!-- 헤더 영역 -->
            <div class="content-header">
                <div class="content-title">
                    Patient List
                    <span class="current-date"></span>
                </div>
                <button class="close-button">Close</button>
            </div>

            <!-- 중간 컨테이너 -->
            <div class="content-body">
            </div>

            <!-- 하단 컨테이너 -->
            <div class="content-footer">
            </div>
        </div>

        <div id="desk-content-right" class="content-container-2 desk-container-right">
            <div class="content-header">
                <div class="content-title">Prescript History</div>
                <button class="close-button">Close</button>
            </div>
        </div>

        <div id="prescription-content" class="content-container prescription-container">
            <div class="content-header">
                <div class="content-title">Prescription</div>
                <button class="close-button">Close</button>
            </div>
            <div class="content-body">
                <div class="no-patient-message" style="display: flex; justify-content: center; align-items: center; height: 100%;">
                    Please select a patient
                </div>
            </div>
        </div>

        <div id="reservation-content" class="content-container reservation-container">
            <div class="content-header">
                <div class="content-title">Reservation</div>
                <button class="close-button">Close</button>
            </div>
            <div class="reservation-form">
                <div class="custom-calendar">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button id="prevMonth">&lt; Prev</button>
                        </div>
                        <div class="month-year">2024년 3월</div>
                        <div class="calendar-nav">
                            <button id="nextMonth">Next &gt;</button>
                        </div>
                    </div>
                    <div class="calendar-grid">
                        <div class="weekday">Sun</div>
                        <div class="weekday">Mon</div>
                        <div class="weekday">Tue</div>
                        <div class="weekday">Wed</div>
                        <div class="weekday">Thu</div>
                        <div class="weekday">Fri</div>
                        <div class="weekday">Sat</div>
                    </div>
                </div>
                
                <div class="daily-scheduler">
                    <div class="scheduler-header">
                        <span class="current-date"></span>
                    </div>
                    <div class="time-grid">
                        <!-- 시간대별 행 (JS로 동적 생성) -->
                    </div>
                </div>
            </div>
        </div>

        <div id="pharmacy-content" class="content-container pharmacy-container">
            <div class="content-header">
                <div class="content-title">Pharmacy</div>
                <button class="close-button">Close</button>
            </div>
        </div>

        <!-- Home 컨테이너 추가 -->
        <div id="home-content" class="content-container">
            <div class="content-body">
                <!-- Home 컨텐츠 내용 -->
            </div>
        </div>
    </div>

</body>
</html>